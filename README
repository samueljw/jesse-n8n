# AivexaLabs n8n Setup Guide

Complete command reference for self-hosting n8n with PostgreSQL for lead generation automation.

---

## Table of Contents
- [Initial Setup](#initial-setup)
- [PostgreSQL Commands](#postgresql-commands)
- [Docker Commands](#docker-commands)
- [n8n Management](#n8n-management)
- [Backup & Restore](#backup--restore)
- [Troubleshooting](#troubleshooting)
- [Deployment](#deployment)
- [Security](#security)

---

## Initial Setup

### Install Docker & Docker Compose
```bash
# Install Docker
curl -fsSL https://get.docker.com | sh

# Add your user to docker group
sudo usermod -aG docker $USER

# Install Docker Compose plugin
sudo apt install docker-compose-plugin -y

# Verify installation
docker --version
docker compose version
```

### Create Project Directory
```bash
# Create directory structure
mkdir -p ~/aivexalabs-n8n/local-files
cd ~/aivexalabs-n8n

# Create docker-compose.yml file
nano docker-compose.yml
```

---

## PostgreSQL Commands

### Local PostgreSQL Setup

#### Installation (Ubuntu)
```bash
# Install PostgreSQL 17
sudo apt update
sudo apt install postgresql-17 postgresql-contrib-17 -y

# Check version
psql --version

# Check status
sudo systemctl status postgresql
```

#### Start/Stop/Restart
```bash
# Start PostgreSQL
sudo systemctl start postgresql

# Stop PostgreSQL
sudo systemctl stop postgresql

# Restart PostgreSQL
sudo systemctl restart postgresql

# Enable on boot
sudo systemctl enable postgresql

# Check if running
sudo systemctl status postgresql
```

#### Database & User Management
```bash
# Connect to PostgreSQL as postgres user
sudo -u postgres psql

# --- Inside PostgreSQL prompt ---

# Create database
CREATE DATABASE aivexalabs_n8n;

# Create user with password
CREATE USER aivexalabs_user WITH ENCRYPTED PASSWORD 'your_secure_password';

# Grant privileges
GRANT ALL PRIVILEGES ON DATABASE aivexalabs_n8n TO aivexalabs_user;

# Connect to database
\c aivexalabs_n8n

# Grant schema privileges (PostgreSQL 15+)
GRANT ALL ON SCHEMA public TO aivexalabs_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO aivexalabs_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO aivexalabs_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO aivexalabs_user;

# List databases
\l

# List users
\du

# Exit PostgreSQL
\q
```

#### Test Connection
```bash
# Test local connection
psql -h localhost -U aivexalabs_user -d aivexalabs_n8n

# Test from command line with password
PGPASSWORD=your_password psql -h localhost -U aivexalabs_user -d aivexalabs_n8n -c "SELECT version();"
```

#### Configuration Files
```bash
# Edit PostgreSQL config
sudo nano /etc/postgresql/17/main/postgresql.conf

# Edit authentication config
sudo nano /etc/postgresql/17/main/pg_hba.conf

# Check where config files are located
sudo -u postgres psql -c "SHOW config_file;"
sudo -u postgres psql -c "SHOW hba_file;"
```

#### Important Configuration Changes

**postgresql.conf:**
```conf
# Allow connections
listen_addresses = 'localhost'  # or '*' for all interfaces
```

**pg_hba.conf (add these lines at the top):**
```conf
# Docker n8n connections
host    aivexalabs_n8n    aivexalabs_user    172.18.0.0/16    scram-sha-256
host    aivexalabs_n8n    aivexalabs_user    172.17.0.0/16    scram-sha-256
host    aivexalabs_n8n    aivexalabs_user    127.0.0.1/32     scram-sha-256
```

#### Monitoring
```bash
# Check if PostgreSQL is listening
sudo netstat -plnt | grep 5432
# or
sudo ss -tulpn | grep 5432

# Check active connections
sudo -u postgres psql -c "SELECT * FROM pg_stat_activity;"

# View PostgreSQL logs
sudo tail -f /var/log/postgresql/postgresql-17-main.log

# View logs with journalctl
sudo journalctl -u postgresql -f
```

---

## Docker Commands

### Basic Docker Operations
```bash
# Check Docker status
sudo systemctl status docker

# Start Docker service
sudo systemctl start docker

# List running containers
docker ps

# List all containers (including stopped)
docker ps -a

# List Docker images
docker images

# List Docker volumes
docker volume ls

# List Docker networks
docker network ls
```

### Docker Compose Commands
```bash
# Start services (in background)
docker compose up -d

# Start services (with logs)
docker compose up

# Stop services
docker compose down

# Restart services
docker compose restart

# View logs (all services)
docker compose logs

# View logs (follow/live)
docker compose logs -f

# View logs (specific service)
docker compose logs -f n8n

# View last 100 lines
docker compose logs --tail=100

# Pull latest images
docker compose pull

# Update and restart
docker compose pull && docker compose up -d

# Check service status
docker compose ps
```

### Container Management
```bash
# Stop container
docker stop aivexalabs-n8n

# Start container
docker start aivexalabs-n8n

# Restart container
docker restart aivexalabs-n8n

# Remove container
docker rm aivexalabs-n8n

# Remove container (force)
docker rm -f aivexalabs-n8n

# Execute command in container
docker exec -it aivexalabs-n8n /bin/sh

# View container logs
docker logs aivexalabs-n8n

# Follow container logs
docker logs -f aivexalabs-n8n

# Inspect container
docker inspect aivexalabs-n8n

# View container resource usage
docker stats aivexalabs-n8n
```

### Volume Management
```bash
# List volumes
docker volume ls

# Inspect volume
docker volume inspect aivexalabs_n8n_data

# Remove volume (WARNING: deletes data)
docker volume rm aivexalabs_n8n_data

# Backup volume
docker run --rm -v aivexalabs_n8n_data:/data -v $(pwd):/backup alpine tar czf /backup/n8n-backup.tar.gz -C /data .

# Restore volume
docker run --rm -v aivexalabs_n8n_data:/data -v $(pwd):/backup alpine tar xzf /backup/n8n-backup.tar.gz -C /data
```

### Image Management
```bash
# Pull n8n image
docker pull n8nio/n8n:latest

# Remove unused images
docker image prune

# Remove all unused images
docker image prune -a

# Check image details
docker inspect n8nio/n8n:latest
```

---

## n8n Management

### Access n8n
```bash
# Local access
http://localhost:5678

# With domain
https://n8n.yourdomain.com

# Default credentials (set in docker-compose.yml)
Username: aivexalabs_admin
Password: AivexaLabs2024!Secure
```

### n8n CLI Commands (inside container)
```bash
# Access n8n container shell
docker exec -it aivexalabs-n8n /bin/sh

# --- Inside container ---

# Check n8n version
n8n --version

# Export workflows
n8n export:workflow --all --output=/files/workflows-backup.json

# Import workflows
n8n import:workflow --input=/files/workflows-backup.json

# Export credentials
n8n export:credentials --all --output=/files/credentials-backup.json

# List workflows
n8n list:workflow

# Update n8n
exit
docker compose pull
docker compose up -d
```

### Environment Variables
```bash
# View container environment
docker exec aivexalabs-n8n env | grep N8N

# Common environment variables:
# N8N_BASIC_AUTH_ACTIVE=true
# N8N_BASIC_AUTH_USER=username
# N8N_BASIC_AUTH_PASSWORD=password
# N8N_HOST=your-domain.com
# N8N_PORT=5678
# N8N_PROTOCOL=https
# WEBHOOK_URL=https://your-domain.com/
# N8N_ENCRYPTION_KEY=your-32-char-key
```

---

## Backup & Restore

### Database Backup
```bash
# Backup PostgreSQL database
pg_dump -h localhost -U aivexalabs_user aivexalabs_n8n > aivexalabs_n8n_backup_$(date +%Y%m%d_%H%M%S).sql

# Backup with compression
pg_dump -h localhost -U aivexalabs_user aivexalabs_n8n | gzip > aivexalabs_n8n_backup_$(date +%Y%m%d_%H%M%S).sql.gz

# Automated backup script
cat > backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="$HOME/backups/n8n"
mkdir -p $BACKUP_DIR
DATE=$(date +%Y%m%d_%H%M%S)
pg_dump -h localhost -U aivexalabs_user aivexalabs_n8n | gzip > $BACKUP_DIR/n8n_$DATE.sql.gz
# Keep only last 7 days
find $BACKUP_DIR -name "n8n_*.sql.gz" -mtime +7 -delete
EOF

chmod +x backup.sh

# Add to crontab (daily at 2 AM)
(crontab -l 2>/dev/null; echo "0 2 * * * $HOME/aivexalabs-n8n/backup.sh") | crontab -
```

### Database Restore
```bash
# Restore from backup
psql -h localhost -U aivexalabs_user -d aivexalabs_n8n < backup_file.sql

# Restore from compressed backup
gunzip -c backup_file.sql.gz | psql -h localhost -U aivexalabs_user -d aivexalabs_n8n

# Drop and recreate database before restore
sudo -u postgres psql << EOF
DROP DATABASE IF EXISTS aivexalabs_n8n;
CREATE DATABASE aivexalabs_n8n;
GRANT ALL PRIVILEGES ON DATABASE aivexalabs_n8n TO aivexalabs_user;
EOF

psql -h localhost -U aivexalabs_user -d aivexalabs_n8n < backup_file.sql
```

### Docker Volume Backup
```bash
# Backup n8n data volume
docker run --rm \
  -v aivexalabs_n8n_data:/data \
  -v $(pwd):/backup \
  alpine tar czf /backup/n8n-data-$(date +%Y%m%d).tar.gz -C /data .

# Restore n8n data volume
docker run --rm \
  -v aivexalabs_n8n_data:/data \
  -v $(pwd):/backup \
  alpine tar xzf /backup/n8n-data-backup.tar.gz -C /data
```

### Complete Backup Script
```bash
#!/bin/bash
BACKUP_DIR="$HOME/backups/n8n"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# Backup database
pg_dump -h localhost -U aivexalabs_user aivexalabs_n8n | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# Backup Docker volume
docker run --rm \
  -v aivexalabs_n8n_data:/data \
  -v $BACKUP_DIR:/backup \
  alpine tar czf /backup/volume_$DATE.tar.gz -C /data .

# Backup docker-compose file
cp docker-compose.yml $BACKUP_DIR/docker-compose_$DATE.yml

echo "Backup completed: $DATE"
```

---

## Troubleshooting

### Check Service Status
```bash
# Check all services
docker compose ps

# Check Docker service
sudo systemctl status docker

# Check PostgreSQL service
sudo systemctl status postgresql

# Check if ports are in use
sudo netstat -tulpn | grep -E '5678|5432'
```

### View Logs
```bash
# n8n logs
docker compose logs -f n8n

# PostgreSQL logs
sudo tail -f /var/log/postgresql/postgresql-17-main.log

# Docker daemon logs
sudo journalctl -u docker -f

# System logs
dmesg | tail
```

### Connection Issues
```bash
# Test PostgreSQL connection
psql -h localhost -U aivexalabs_user -d aivexalabs_n8n

# Check Docker network
docker network inspect bridge

# Test from n8n container
docker exec -it aivexalabs-n8n ping host.docker.internal
docker exec -it aivexalabs-n8n nc -zv host.docker.internal 5432

# Check firewall
sudo ufw status
sudo iptables -L -n
```

### Container Issues
```bash
# Restart everything
docker compose down
docker compose up -d

# Remove and recreate
docker compose down -v
docker compose up -d

# Check container health
docker inspect --format='{{.State.Health.Status}}' aivexalabs-n8n

# View container processes
docker top aivexalabs-n8n
```

### Database Issues
```bash
# Check database size
sudo -u postgres psql -c "SELECT pg_size_pretty(pg_database_size('aivexalabs_n8n'));"

# Check active connections
sudo -u postgres psql -c "SELECT * FROM pg_stat_activity WHERE datname='aivexalabs_n8n';"

# Kill hanging queries
sudo -u postgres psql -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname='aivexalabs_n8n' AND pid <> pg_backend_pid();"

# Vacuum database
sudo -u postgres psql aivexalabs_n8n -c "VACUUM ANALYZE;"
```

### Reset Everything
```bash
# WARNING: This deletes all data!

# Stop and remove containers
docker compose down -v

# Remove database
sudo -u postgres psql -c "DROP DATABASE IF EXISTS aivexalabs_n8n;"

# Recreate database
sudo -u postgres psql << EOF
CREATE DATABASE aivexalabs_n8n;
GRANT ALL PRIVILEGES ON DATABASE aivexalabs_n8n TO aivexalabs_user;
EOF

# Start fresh
docker compose up -d
```

---

## Deployment

### VPS Provider Setup

#### DigitalOcean Droplet
```bash
# After creating droplet, SSH in:
ssh root@your_server_ip

# Update system
apt update && apt upgrade -y

# Install Docker
curl -fsSL https://get.docker.com | sh

# Install Docker Compose
apt install docker-compose-plugin -y

# Create user (optional)
adduser aivexalabs
usermod -aG sudo aivexalabs
usermod -aG docker aivexalabs

# Switch to user
su - aivexalabs

# Clone your setup or create files
mkdir ~/aivexalabs-n8n
cd ~/aivexalabs-n8n
# Upload your docker-compose.yml

# Start services
docker compose up -d
```

#### Hetzner Cloud
```bash
# Same as DigitalOcean, after SSH:
ssh root@your_server_ip

# Follow same steps as above
```

### Domain Setup
```bash
# Point domain A record to server IP
# Example DNS settings:
# A record: n8n.yourdomain.com -> YOUR_SERVER_IP

# Install Nginx
sudo apt install nginx -y

# Create Nginx config
sudo nano /etc/nginx/sites-available/n8n

# Add this configuration:
# (See SSL/HTTPS section below)

# Enable site
sudo ln -s /etc/nginx/sites-available/n8n /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### SSL/HTTPS Setup
```bash
# Install Certbot
sudo apt install certbot python3-certbot-nginx -y

# Get SSL certificate
sudo certbot --nginx -d n8n.yourdomain.com

# Auto-renewal is set up automatically
# Test renewal
sudo certbot renew --dry-run

# Check certificate expiry
sudo certbot certificates
```

### Nginx Configuration for n8n
```nginx
server {
    listen 80;
    server_name n8n.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name n8n.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/n8n.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/n8n.yourdomain.com/privkey.pem;

    location / {
        proxy_pass http://localhost:5678;
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        chunked_transfer_encoding off;
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### Update docker-compose.yml for Production
```yaml
# Update these environment variables:
- N8N_HOST=n8n.yourdomain.com
- N8N_PROTOCOL=https
- WEBHOOK_URL=https://n8n.yourdomain.com/
```

---

## Security

### Firewall Setup (UFW)
```bash
# Install UFW
sudo apt install ufw -y

# Default policies
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Allow SSH
sudo ufw allow ssh
sudo ufw allow 22/tcp

# Allow HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Don't expose n8n port directly (use Nginx)
# sudo ufw allow 5678/tcp  # NOT recommended

# Enable firewall
sudo ufw enable

# Check status
sudo ufw status verbose
```

### Fail2Ban Setup
```bash
# Install Fail2Ban
sudo apt install fail2ban -y

# Start service
sudo systemctl start fail2ban
sudo systemctl enable fail2ban

# Check status
sudo fail2ban-client status

# Check SSH jail
sudo fail2ban-client status sshd
```

### Secure PostgreSQL
```bash
# Change postgres user password
sudo -u postgres psql -c "ALTER USER postgres PASSWORD 'new_strong_password';"

# Restrict pg_hba.conf (only local connections)
sudo nano /etc/postgresql/17/main/pg_hba.conf

# Keep only these lines:
local   all             postgres                                peer
local   all             all                                     peer
host    aivexalabs_n8n  aivexalabs_user  127.0.0.1/32          scram-sha-256
host    aivexalabs_n8n  aivexalabs_user  ::1/128               scram-sha-256

# Restart PostgreSQL
sudo systemctl restart postgresql
```

### Secure Docker
```bash
# Don't run as root
sudo usermod -aG docker $USER

# Use secrets for sensitive data
# Create secrets file
echo "your_db_password" > db_password.txt
chmod 600 db_password.txt

# Update docker-compose to use secrets
# (Advanced - see Docker secrets documentation)
```

### Regular Updates
```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Update Docker images
cd ~/aivexalabs-n8n
docker compose pull
docker compose up -d

# Check for security updates
sudo apt list --upgradable
```

### Monitoring
```bash
# Install monitoring tools
sudo apt install htop iotop nethogs -y

# Monitor system resources
htop

# Monitor disk usage
df -h
du -sh /var/lib/docker

# Monitor Docker
docker stats

# Set up log rotation
sudo nano /etc/logrotate.d/n8n

# Add:
/var/log/n8n/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 root root
    sharedscripts
}
```

---

## Quick Reference

### Most Used Commands
```bash
# Start n8n
cd ~/aivexalabs-n8n && docker compose up -d

# Stop n8n
docker compose down

# View logs
docker compose logs -f

# Restart n8n
docker compose restart

# Update n8n
docker compose pull && docker compose up -d

# Backup database
pg_dump -h localhost -U aivexalabs_user aivexalabs_n8n > backup.sql

# Access PostgreSQL
psql -h localhost -U aivexalabs_user -d aivexalabs_n8n

# Check status
docker compose ps
sudo systemctl status postgresql
```

### Important Files
```bash
# Docker Compose file
~/aivexalabs-n8n/docker-compose.yml

# n8n data volume
/var/lib/docker/volumes/aivexalabs_n8n_data

# PostgreSQL config
/etc/postgresql/17/main/postgresql.conf
/etc/postgresql/17/main/pg_hba.conf

# PostgreSQL data
/var/lib/postgresql/17/main

# Nginx config (if using)
/etc/nginx/sites-available/n8n

# SSL certificates
/etc/letsencrypt/live/n8n.yourdomain.com/
```

### Support & Resources
- **n8n Documentation**: https://docs.n8n.io
- **n8n Community**: https://community.n8n.io
- **PostgreSQL Docs**: https://www.postgresql.org/docs/
- **Docker Docs**: https://docs.docker.com

---

## Lead Generation Workflow Tips

### LinkedIn Sales Navigator + n8n Setup
```bash
# Install required nodes in n8n:
# - HTTP Request (for APIs)
# - Google Sheets (for lead storage)
# - Webhook (for triggers)
# - Function (for data transformation)
# - IF (for lead qualification)

# Tools to integrate:
# - PhantomBuster (LinkedIn scraping)
# - Hunter.io (email finding)
# - Clearbit (data enrichment)
# - Your CRM (HubSpot, Salesforce, etc.)
```

### Workflow Structure
1. **Extract**: Sales Navigator → CSV/API → n8n
2. **Enrich**: Find emails, company data
3. **Qualify**: Filter by ICP criteria
4. **Store**: Save to CRM/Google Sheets
5. **Engage**: Trigger email sequences

---

**Created by AivexaLabs**
**Last Updated**: December 2025
**Version**: 1.0